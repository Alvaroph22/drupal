<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Database\Database;
use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\HtmlCommand;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_form_FORM_ID_alter() for node_form().
 */
function formulario_bluecell_form_node_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Verifica que estemos en la página de un nodo individual (single.php).
  if ($form_state->get('view_mode') === 'full') {
    // Agrega el formulario después del campo de contenido.
    $form['formulario_bluecell'] = [
      '#type' => 'container',
      '#attributes' => ['class' => ['formulario-bluecell']],
    ];

    // Agrega los campos del formulario.
    $form['formulario_bluecell']['nombre'] = [
      '#type' => 'textfield',
      '#title' => t('Nombre'),
      '#required' => TRUE,
    ];

    $form['formulario_bluecell']['email'] = [
      '#type' => 'email',
      '#title' => t('Email'),
      '#required' => TRUE,
    ];

    $form['formulario_bluecell']['telefono'] = [
      '#type' => 'tel',
      '#title' => t('Teléfono'),
      '#required' => TRUE,
    ];

    $form['formulario_bluecell']['mensaje'] = [
      '#type' => 'textarea',
      '#title' => t('Mensaje'),
      '#required' => TRUE,
    ];

    $form['formulario_bluecell']['asunto'] = [
      '#type' => 'textfield',
      '#title' => t('Asunto'),
      '#required' => TRUE,
    ];

    $form['formulario_bluecell']['aceptacion_politicas'] = [
      '#type' => 'checkbox',
      '#title' => t('Acepto las políticas'),
      '#required' => TRUE,
    ];

    // Agrega un botón de envío personalizado.
    $form['formulario_bluecell']['submit'] = [
      '#type' => 'submit',
      '#value' => t('Enviar'),
      '#ajax' => [
        'callback' => 'formulario_bluecell_ajax_submit',
      ],
    ];
  }
}

/**
 * Ajax callback para el formulario de envío.
 */
function formulario_bluecell_ajax_submit(array &$form, FormStateInterface $form_state) {
  $response = new AjaxResponse();

  // Valida el formulario.
  if ($form_state->hasAnyErrors()) {
    $response->addCommand(new HtmlCommand('.formulario-bluecell', render($form)));
  } else {
    // Guarda los datos en la base de datos.
    $nombre = $form_state->getValue('nombre');
    $email = $form_state->getValue('email');
    $telefono = $form_state->getValue('telefono');
    $mensaje = $form_state->getValue('mensaje');
    $asunto = $form_state->getValue('asunto');
    $fecha = \Drupal::time()->getCurrentTime();

    $connection = Database::getConnection();
    $connection->insert('formulario_bluecell_data')
      ->fields([
        'nombre' => $nombre,
        'email' => $email,
        'telefono' => $telefono,
        'mensaje' => $mensaje,
        'asunto' => $asunto,
        'fecha' => $fecha,
      ])
      ->execute();

    // Limpia los campos del formulario.
    $form_state->setValue('nombre', '');
    $form_state->setValue('email', '');
    $form_state->setValue('telefono', '');
    $form_state->setValue('mensaje', '');
    $form_state->setValue('asunto', '');
    $form_state->setValue('aceptacion_politicas', '');

    // Muestra un mensaje de éxito.
    $response->addCommand(new HtmlCommand('.formulario-bluecell', '<p>Formulario enviado con éxito.</p>'));
  }

  return $response;
}

/**
 * Implements hook_menu() to define a custom page.
 */
function formulario_bluecell_menu() {
  $items = [];

  $items['admin/formulario-bluecell-data'] = [
    'title' => 'Datos del Formulario Bluecell',
    'description' => 'Muestra los datos enviados desde el formulario.',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['formulario_bluecell_data_table'],
    'access arguments' => ['administer site configuration'],
    'type' => MENU_NORMAL_ITEM,
  ];

  return $items;
}

/**
 * Formulario para mostrar los datos del formulario.
 */
function formulario_bluecell_data_table($form, FormStateInterface $form_state) {
  $header = [
    'ID',
    'Nombre',
    'Email',
    'Teléfono',
    'Mensaje',
    'Asunto',
    'Fecha',
  ];

  $query = \Drupal::database()->select('formulario_bluecell_data', 'f')
    ->fields('f')
    ->extend('Drupal\Core\Database\Query\TableSortExtender')
    ->extend('Drupal\Core\Database\Query\PagerSelectExtender')
    ->orderByHeader($header)
    ->limit(50);

  $results = $query->execute();

  foreach ($results as $row) {
    $rows[] = [
      $row->id,
      $row->nombre,
      $row->email,
      $row->telefono,
      $row->mensaje,
      $row->asunto,
      date('Y-m-d H:i:s', $row->fecha),
    ];
  }

  $form['table'] = [
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('No se encontraron datos.'),
  ];

  // Agregar la librería DataTables.
  $form['#attached']['library'][] = 'datatables/datatables';

  return $form;
}
